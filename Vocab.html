<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocab Master - æ²‰æµ¸å¼å•è¯è®°å¿†</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <style>
        /* --- Material Design 3 ç³»ç»Ÿå˜é‡ --- */
        :root {
            --md-sys-color-primary: #006492;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #cae6ff;
            --md-sys-color-on-primary-container: #001e30;
            --md-sys-color-secondary: #50606e;
            --md-sys-color-secondary-container: #d3e5f5;
            --md-sys-color-background: #f8fdff;
            --md-sys-color-surface: #f8fdff;
            --md-sys-color-surface-container: #ffffff;
            --md-sys-color-on-surface: #001e2f;
            --md-sys-color-outline: #72777f;
            --md-sys-color-outline-variant: #c2c7cf;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-success: #2e7d32;
            
            --border-radius-lg: 24px;
            --border-radius-md: 16px;
            
            --shadow-1: 0 1px 2px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.04);
            --shadow-2: 0 4px 8px rgba(0,0,0,0.08), 0 8px 16px rgba(0,0,0,0.04);
            
            --font-family-base: 'Google Sans', 'Roboto', sans-serif;
            --anim-curve: cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        [data-theme="dark"] {
            --md-sys-color-primary: #8ccaff;
            --md-sys-color-on-primary: #00334e;
            --md-sys-color-primary-container: #004b6f;
            --md-sys-color-on-primary-container: #cae6ff;
            --md-sys-color-secondary: #b7c9d9;
            --md-sys-color-secondary-container: #394956;
            --md-sys-color-background: #001e2f;
            --md-sys-color-surface: #001e2f;
            --md-sys-color-surface-container: #0f2a3d;
            --md-sys-color-on-surface: #c4e7ff;
            --md-sys-color-outline: #8c9199;
            --md-sys-color-outline-variant: #42474e;
        }

        /* --- åŠ¨ç”»å®šä¹‰ --- */
        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .animate-enter {
            animation: fadeSlideUp 0.5s var(--anim-curve) forwards;
        }

        .animate-shake {
            animation: shake 0.4s ease-in-out;
        }

        .animate-pop {
            animation: pop 0.3s var(--anim-curve);
        }

        /* --- åŸºç¡€å¸ƒå±€ --- */
        body {
            font-family: var(--font-family-base);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            transition: background-color 0.3s;
        }

        #app-layout {
            width: 100%;
            max-width: 680px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- å¤´éƒ¨å¯¼èˆª --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0 20px 0;
            margin-bottom: 10px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        .logo-icon {
            font-size: 32px;
            color: var(--md-sys-color-primary);
        }

        h1 {
            font-size: 1.5rem;
            margin: 0;
            font-weight: 500;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--md-sys-color-on-surface);
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .icon-btn:hover { background-color: rgba(128,128,128,0.1); }
        .material-symbols-rounded { font-size: 24px; }

        /* --- å¡ç‰‡é€šç”¨æ ·å¼ --- */
        .card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: var(--border-radius-lg);
            padding: 32px;
            box-shadow: var(--shadow-1);
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }
        
        .hidden { display: none !important; }

        /* --- ä»ªè¡¨ç›˜ --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-surface);
            padding: 24px;
            border-radius: var(--border-radius-md);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: var(--md-sys-color-primary); line-height: 1.2; }
        .stat-label { font-size: 0.9rem; opacity: 0.8; margin-top: 4px; }

        .progress-ring-container {
            grid-column: span 2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 24px 32px;
            border-radius: var(--border-radius-lg);
        }

        /* --- æŒ‰é’®æ ·å¼ --- */
        .btn {
            height: 48px;
            padding: 0 24px;
            border-radius: 24px;
            border: none;
            font-family: var(--font-family-base);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .btn:active { transform: scale(0.98); }

        .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .btn-primary:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.2); filter: brightness(1.1); }
        
        .btn-tonal {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-surface);
        }
        .btn-tonal:hover { filter: brightness(0.95); }

        .btn-text {
            background: transparent;
            color: var(--md-sys-color-primary);
        }
        .btn-text:hover { background-color: rgba(var(--md-sys-color-primary), 0.08); }

        .action-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        
        /* --- å­¦ä¹ ç•Œé¢ --- */
        .word-display {
            text-align: center;
            margin: 40px 0;
        }
        
        .main-word {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 16px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .main-word:hover { color: var(--md-sys-color-primary); }
        
        .phonetic-btn {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-surface);
            border: none;
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s;
        }
        .phonetic-btn:active { transform: scale(0.95); }

        /* é»˜å†™æ¨¡å¼è¾“å…¥æ¡† */
        .spelling-input-container {
            margin: 20px 0;
            text-align: center;
        }
        .spelling-input {
            width: 80%;
            padding: 16px 20px;
            font-size: 2rem;
            text-align: center;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 16px;
            background: transparent;
            color: var(--md-sys-color-on-surface);
            outline: none;
            transition: all 0.3s var(--anim-curve);
            font-family: monospace; 
            font-weight: bold;
        }
        .spelling-input:focus {
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 4px rgba(var(--md-sys-color-primary), 0.1);
        }
        .spelling-input::placeholder { color: var(--md-sys-color-outline-variant); font-size: 1.5rem; font-weight: normal; }

        /* æ‹¼å†™æ­£ç¡®æ ·å¼ */
        .spelling-input.correct {
            border-color: var(--md-sys-color-success);
            color: var(--md-sys-color-success);
            background-color: rgba(46, 125, 50, 0.05);
        }
        /* æ‹¼å†™é”™è¯¯æ ·å¼ */
        .spelling-input.wrong {
            border-color: var(--md-sys-color-error);
            color: var(--md-sys-color-error);
            background-color: rgba(186, 26, 26, 0.05);
        }

        /* é€‰é¡¹å¡ç‰‡ */
        .quiz-grid {
            display: grid;
            grid-template-columns: 1fr; /* Mobile First, single column */
            gap: 12px;
            margin-top: 32px;
        }
        @media (min-width: 500px) {
            .quiz-grid { grid-template-columns: 1fr 1fr; }
        }
        
        .quiz-option {
            background: transparent;
            border: 1px solid var(--md-sys-color-outline-variant);
            padding: 24px 20px;
            border-radius: 16px;
            text-align: left;
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            min-height: 60px;
        }
        
        .quiz-option:hover {
            background-color: var(--md-sys-color-secondary-container);
            border-color: var(--md-sys-color-secondary);
        }
        .quiz-option.correct {
            background-color: var(--md-sys-color-success);
            color: white;
            border-color: transparent;
        }
        .quiz-option.wrong {
            background-color: var(--md-sys-color-error);
            color: white;
            border-color: transparent;
            opacity: 0.6;
        }

        /* å¼€å…³ Toggle */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            justify-content: center;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--md-sys-color-secondary);
            background: var(--md-sys-color-surface-container);
            padding: 8px 16px;
            border-radius: 30px;
            box-shadow: var(--shadow-1);
        }
        .switch-input { display: none; }
        .switch-label {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 32px;
            background-color: var(--md-sys-color-outline-variant);
            border-radius: 16px;
            transition: 0.3s;
            cursor: pointer;
        }
        .switch-label::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s var(--anim-curve);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .switch-input:checked + .switch-label { background-color: var(--md-sys-color-primary); }
        .switch-input:checked + .switch-label::after { transform: translateX(20px); }

        /* --- æ‚¬æµ®æ“ä½œæŒ‰é’® (FAB) --- */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: var(--shadow-2);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: transform 0.2s var(--anim-curve);
            z-index: 100;
        }
        .fab:hover { transform: scale(1.1) rotate(5deg); }

        /* --- å¯¹è¯æ¡† --- */
        dialog {
            border: none;
            border-radius: 28px;
            padding: 24px;
            background-color: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
            box-shadow: var(--shadow-2);
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        dialog h3 { margin-top: 0; color: var(--md-sys-color-primary); }
        
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 500;}
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 8px;
            background: transparent;
            color: var(--md-sys-color-on-surface);
            box-sizing: border-box;
            font-family: inherit;
        }
        .input-group textarea { resize: vertical; min-height: 150px; font-size: 0.9rem;}
        .input-group input:focus, .input-group textarea:focus { outline: 2px solid var(--md-sys-color-primary); border-color: transparent; }

        /* è¯¦æƒ…é¡µæ ·å¼ä¼˜åŒ– */
        .detail-box {
            background-color: var(--md-sys-color-primary-container);
            border-left: 4px solid var(--md-sys-color-primary);
            padding: 16px;
            margin: 16px 0;
            text-align: left;
            border-radius: 0 8px 8px 0;
            color: var(--md-sys-color-on-primary-container);
        }

        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #323232;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 999;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; }

        /* --- å¿«æ·é”®è®¾ç½®æ ·å¼ --- */
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            padding-bottom: 12px;
        }
        .shortcut-label {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .shortcut-keys {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-end;
            max-width: 60%;
        }
        .key-tag {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-surface);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-family: monospace;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
        }
        .key-tag:hover {
            border-color: var(--md-sys-color-error);
            color: var(--md-sys-color-error);
        }
        .key-tag span { font-size: 14px; } /* Close icon */

        .add-key-btn {
            background: var(--md-sys-color-outline-variant);
            color: var(--md-sys-color-on-surface);
            border: 1px dashed var(--md-sys-color-outline);
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .add-key-btn.recording {
            background-color: var(--md-sys-color-error);
            color: white;
            border-style: solid;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

    </style>
</head>
<body data-theme="light">

    <div id="app-layout">
        <header>
            <div class="logo-area" onclick="showDashboard()">
                <span class="material-symbols-rounded logo-icon">school</span>
                <h1>Vocab Master</h1>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="icon-btn" id="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜">
                    <span class="material-symbols-rounded">dark_mode</span>
                </button>
                <button class="icon-btn" onclick="openSettings()" title="è®¾ç½®">
                    <span class="material-symbols-rounded">settings</span>
                </button>
            </div>
        </header>

        <section id="dashboard-view" class="animate-enter">
            <div class="card progress-ring-container">
                <div>
                    <h2 style="margin: 0; font-size: 1.2rem;">ä»Šæ—¥å­¦ä¹ æ¦‚è§ˆ</h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.8;" id="dash-progress-text">åŠ è½½ä¸­...</p>
                </div>
                <button id="main-start-btn" class="btn btn-primary" style="background-color: white; color: var(--md-sys-color-primary); font-weight: bold;">
                    <span class="material-symbols-rounded">play_arrow</span> å¼€å§‹å­¦ä¹ 
                </button>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-number" id="dash-total">0</div>
                    <div class="stat-label">è¯æ±‡æ€»é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="dash-mastered" style="color: var(--md-sys-color-success);">0</div>
                    <div class="stat-label">å·²æŒæ¡</div>
                </div>
            </div>

            <div class="action-row">
                <button class="btn btn-tonal" onclick="document.getElementById('file-import-dialog').showModal()">
                    <span class="material-symbols-rounded">upload_file</span> TXT å¯¼å…¥
                </button>
                <button class="btn btn-tonal" onclick="showWordBank()">
                    <span class="material-symbols-rounded">book</span> å•è¯æœ¬
                </button>
            </div>
        </section>

        <section id="study-view" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="icon-btn" onclick="showDashboard()">
                    <span class="material-symbols-rounded">arrow_back</span>
                </button>
                <div class="toggle-switch">
                    <span>é€‰æ„</span>
                    <input type="checkbox" id="spelling-mode-toggle" class="switch-input">
                    <label for="spelling-mode-toggle" class="switch-label"></label>
                    <span>æ‹¼å†™</span>
                </div>
                <span id="study-progress" style="font-size: 0.9rem; color: var(--md-sys-color-secondary); font-variant-numeric: tabular-nums;">0/0</span>
            </div>

            <div class="card" id="study-card">
                <div id="phase-1" class="animate-enter">
                    <div class="word-display">
                        <div class="main-word" id="p1-word">Word</div>
                        <button class="phonetic-btn" id="p1-speak-btn">
                            <span class="material-symbols-rounded">volume_up</span> å‘éŸ³
                        </button>
                    </div>
                    <div class="action-row">
                        <button class="btn btn-tonal" id="p1-forget-btn" style="color: var(--md-sys-color-error);">
                            <span class="material-symbols-rounded">close</span> ä¸è®¤è¯†
                        </button>
                         <button class="btn btn-primary" id="p1-know-btn" style="flex-grow: 1;">
                            <span class="material-symbols-rounded">check</span> è®¤è¯† / æµ‹è¯•
                        </button>
                         <button class="btn btn-tonal" id="p1-kill-btn" title="æ°¸ä¹…æŒæ¡">
                            <span class="material-symbols-rounded">delete_forever</span>
                        </button>
                    </div>
                </div>

                <div id="phase-2" class="hidden">
                    
                    <div style="text-align: center; margin-bottom: 30px;">
                        <p style="color: var(--md-sys-color-secondary); font-size: 0.9rem;">è¯·é€‰æ‹©å¯¹åº”çš„ä¸­æ–‡æˆ–æ‹¼å†™å•è¯ï¼š</p>
                        <h2 id="quiz-word-prompt" style="font-size: 2.5rem; color: var(--md-sys-color-primary); cursor:pointer;">Word</h2>
                    </div>
                    
                    <div id="quiz-options-container" class="quiz-grid"></div>
                    
                    <div id="spelling-container" class="hidden spelling-input-container">
                        <input type="text" id="spelling-input" class="spelling-input" placeholder="è¾“å…¥å•è¯..." autocomplete="off" spellcheck="false">
                        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                            <button class="btn btn-primary" id="submit-spelling-btn">ç¡®è®¤ (Enter)</button>
                            <button class="btn btn-text" id="hint-spelling-btn">æç¤º</button>
                        </div>
                    </div>
                </div>

                <div id="phase-3" class="hidden">
                    <div style="text-align: center;">
                        <h2 style="font-size: 2.5rem; color: var(--md-sys-color-primary); margin: 0;" id="p3-word">Word</h2>
                        <button class="icon-btn" id="p3-speak-btn" style="margin: 10px auto;">
                            <span class="material-symbols-rounded">volume_up</span>
                        </button>
                    </div>
                    
                    <div class="detail-box">
                        <div style="font-weight: bold; margin-bottom: 4px; font-size: 0.9rem; opacity: 0.8;">ä¸­æ–‡é‡Šä¹‰</div>
                        <div id="p3-meaning" style="font-size: 1.2rem; font-weight: 500;">...</div>
                    </div>
                    
                    <div style="margin-top: 24px;">
                        <p style="font-size: 0.9rem; color: var(--md-sys-color-secondary); font-weight: bold;">ä¾‹å¥ï¼š</p>
                        <p id="p3-example-en" style="font-style: italic; font-size: 1.1rem; margin-bottom: 8px;">...</p>
                        <p id="p3-example-zh" style="opacity: 0.8;">...</p>
                    </div>

                    <div class="action-row" style="margin-top: 40px;">
                        <button class="btn btn-tonal" id="p3-loop-btn">
                            <span class="material-symbols-rounded">replay</span> å¿˜è®°äº†ï¼Œé‡æ¥
                        </button>
                        <button class="btn btn-primary" id="p3-next-btn">
                            ä¸‹ä¸€ä¸ª <span class="material-symbols-rounded">arrow_forward</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="bank-view" class="hidden animate-enter">
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                 <button class="icon-btn" onclick="showDashboard()">
                    <span class="material-symbols-rounded">arrow_back</span>
                </button>
                <h2 style="margin-left: 10px;">è¯åº“ç®¡ç†</h2>
            </div>
            <div class="card">
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-tonal" id="filter-all" onclick="renderBank('all')">å…¨éƒ¨</button>
                    <button class="btn btn-tonal" id="filter-wrong" onclick="renderBank('wrong')">é”™è¯</button>
                    <button class="btn btn-tonal" id="filter-mastered" onclick="renderBank('mastered')">å·²æŒæ¡</button>
                </div>
                <div id="bank-list" style="max-height: 500px; overflow-y: auto; padding-right: 5px;">
                    </div>
            </div>
        </section>

    </div>

    <button class="fab" onclick="document.getElementById('text-import-dialog').showModal()" title="ç²˜è´´æ‰¹é‡å¯¼å…¥">
        <span class="material-symbols-rounded">content_paste</span>
    </button>

    <dialog id="text-import-dialog">
        <h3>ğŸ“„ æ‰¹é‡ç²˜è´´å¯¼å…¥</h3>
        <p style="font-size: 0.9rem; color: var(--md-sys-color-secondary); margin-bottom: 12px;">
            è¯·æŒ‰ç…§ **å•è¯ | é‡Šä¹‰ | ä¾‹å¥En | ä¾‹å¥Cn** æ ¼å¼ï¼Œæ¯è¡Œä¸€ä¸ªè¯ï¼š
        </p>
        <form id="text-import-form">
            <div class="input-group">
                <textarea id="import-text-area" required placeholder="ä¾‹å¦‚ï¼š&#10;Serendipity | n. æ„å¤–å‘ç°çå¥‡äº‹ç‰©çš„æœ¬é¢† | It was pure serendipity... | é‚£çº¯ç²¹æ˜¯æœºç¼˜å·§åˆ..."></textarea>
            </div>
            <div class="action-row" style="margin-top: 0; justify-content: flex-end;">
                <button type="button" class="btn btn-text" onclick="document.getElementById('text-import-dialog').close()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">å¼€å§‹å¯¼å…¥</button>
            </div>
        </form>
    </dialog>

    <dialog id="file-import-dialog">
        <h3>ğŸ“‚ TXT æ–‡ä»¶å¯¼å…¥</h3>
        <p style="font-size: 0.9rem; color: var(--md-sys-color-secondary);">æ ¼å¼åŒä¸Š: å•è¯ | é‡Šä¹‰ | ä¾‹å¥En | ä¾‹å¥Cn</p>
        <input type="file" id="file-input" accept=".txt" style="margin: 20px 0;">
        <div class="action-row" style="justify-content: flex-end;">
             <button type="button" class="btn btn-text" onclick="document.getElementById('file-import-dialog').close()">å…³é—­</button>
             <button type="button" class="btn btn-primary" id="confirm-file-import-btn">å¯¼å…¥</button>
        </div>
    </dialog>

    <dialog id="settings-dialog">
        <h3>âš™ï¸ è®¾ç½®</h3>
        
        <h4 style="margin: 16px 0 8px 0; color: var(--md-sys-color-primary);">åŸºæœ¬è®¾ç½®</h4>
        <div class="input-group">
            <label>TTS è¯­é€Ÿ (0.5 - 1.5)</label>
            <input type="range" id="tts-rate" min="0.5" max="1.5" step="0.1" value="1.0" oninput="document.getElementById('rate-val').innerText = this.value">
            <span id="rate-val" style="float: right; font-size: 0.8rem;">1.0</span>
        </div>

        <h4 style="margin: 24px 0 12px 0; color: var(--md-sys-color-primary);">âŒ¨ï¸ é”®ç›˜å¿«æ·é”®</h4>
        <p style="font-size:0.8rem; color: var(--md-sys-color-secondary); margin-top:-8px; margin-bottom:12px;">ç‚¹å‡» + å·ï¼Œç„¶åæŒ‰ä¸‹é”®ç›˜å³å¯ç»‘å®šã€‚</p>
        
        <div id="shortcut-list">
            </div>

        <div style="margin-top: 32px; border-top: 1px solid var(--md-sys-color-outline-variant); padding-top: 16px;">
            <button class="btn btn-text" style="color: var(--md-sys-color-error);" id="reset-data-btn">âš ï¸ é‡ç½®æ‰€æœ‰å•è¯æ•°æ®</button>
        </div>
        <div class="action-row" style="justify-content: flex-end;">
            <button class="btn btn-primary" onclick="document.getElementById('settings-dialog').close()">å®Œæˆ</button>
        </div>
    </dialog>

    <div id="toast">æç¤ºä¿¡æ¯</div>

    <script>
        /* --- æ ¸å¿ƒé€»è¾‘ --- */
        const STORAGE_KEY = 'vocab_master_v1';
        const SHORTCUT_KEY = 'vocab_master_shortcuts';
        let wordList = [];
        let reviewQueue = [];
        let currentWord = null;
        let currentWordIndex = 0;
        let ttsRate = 1.0;
        
        // TTS å˜é‡
        let synth = window.speechSynthesis;
        let voices = [];

        // å¿«æ·é”®ç®¡ç†å™¨
        const Shortcuts = {
            data: {
                confirm: ['Space', 'Enter', 'KeyQ'], // è®¤è¯† / ä¸‹ä¸€ä¸ª / ç¡®è®¤
                reject: ['KeyE'],                    // ä¸è®¤è¯† / é‡æ¥
                audio: ['KeyR'],                     // å‘éŸ³
                master: ['KeyK'],                    // æ°¸ä¹…æŒæ¡
                hint: ['KeyH']                       // æ‹¼å†™æç¤º
            },
            labels: {
                confirm: 'è®¤è¯† / ä¸‹ä¸€ä¸ª (ç¡®è®¤)',
                reject: 'ä¸è®¤è¯† / å¿˜è®°äº† (é‡æ¥)',
                audio: 'æ’­æ”¾å‘éŸ³',
                master: 'æ°¸ä¹…æŒæ¡ (æ–©è¯)',
                hint: 'æ‹¼å†™æç¤º'
            },
            
            init() {
                const saved = localStorage.getItem(SHORTCUT_KEY);
                if (saved) {
                    // åˆå¹¶ä¿å­˜çš„è®¾ç½®ï¼Œé˜²æ­¢æ–°ç‰ˆæœ¬åŠ äº†keyæ—§ç‰ˆæœ¬æŠ¥é”™
                    this.data = { ...this.data, ...JSON.parse(saved) };
                }
            },
            
            save() {
                localStorage.setItem(SHORTCUT_KEY, JSON.stringify(this.data));
            },
            
            add(action, code) {
                if (!this.data[action].includes(code)) {
                    this.data[action].push(code);
                    this.save();
                    return true;
                }
                return false;
            },
            
            remove(action, code) {
                this.data[action] = this.data[action].filter(c => c !== code);
                this.save();
            },
            
            getAction(code) {
                for (const [action, keys] of Object.entries(this.data)) {
                    if (keys.includes(code)) return action;
                }
                return null;
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            Shortcuts.init(); // åˆå§‹åŒ–å¿«æ·é”®
            updateDashboard();
            setupEventListeners();
            
            // åˆå§‹åŒ– TTS Voice
            if (synth) {
                voices = synth.getVoices();
                synth.onvoiceschanged = () => { voices = synth.getVoices(); };
            }
            
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        });

        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                wordList = JSON.parse(data);
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(wordList));
            updateDashboard();
        }

        // --- å¯¼èˆªä¸è§†å›¾ ---
        function showDashboard() {
            hideAllViews();
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('dashboard-view').classList.remove('animate-enter');
            void document.getElementById('dashboard-view').offsetWidth; 
            document.getElementById('dashboard-view').classList.add('animate-enter');
            updateDashboard();
        }

        function showStudy() {
            updateReviewQueue();
            if (reviewQueue.length === 0) {
                showToast("ğŸ‰ å¤ªæ£’äº†ï¼ä»Šæ—¥æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ã€‚");
                return;
            }
            hideAllViews();
            document.getElementById('study-view').classList.remove('hidden');
            currentWordIndex = 0;
            loadNextWord();
        }

        function showWordBank() {
            hideAllViews();
            document.getElementById('bank-view').classList.remove('hidden');
            document.getElementById('bank-view').classList.remove('animate-enter');
            void document.getElementById('bank-view').offsetWidth; 
            document.getElementById('bank-view').classList.add('animate-enter');
            renderBank('all');
        }

        function openSettings() {
            renderShortcutSettings();
            document.getElementById('settings-dialog').showModal();
        }

        function hideAllViews() {
            ['dashboard-view', 'study-view', 'bank-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        // --- ä»ªè¡¨ç›˜é€»è¾‘ ---
        function updateDashboard() {
            const total = wordList.length;
            const mastered = wordList.filter(w => w.mastered).length;
            const now = Date.now();
            const due = wordList.filter(w => !w.mastered && w.nextReview <= now).length;

            document.getElementById('dash-total').textContent = total;
            document.getElementById('dash-mastered').textContent = mastered;
            
            const btn = document.getElementById('main-start-btn');
            if (total === 0) {
                document.getElementById('dash-progress-text').textContent = "è¯·å…ˆæ·»åŠ æˆ–å¯¼å…¥å•è¯";
                btn.disabled = true;
                btn.style.opacity = 0.5;
                btn.innerHTML = '<span class="material-symbols-rounded">cloud_upload</span> å¯¼å…¥è¯åº“';
            } else if (due === 0) {
                document.getElementById('dash-progress-text').textContent = "ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼";
                btn.innerHTML = '<span class="material-symbols-rounded">check</span> ä»»åŠ¡å®Œæˆ';
                btn.disabled = false;
                btn.style.opacity = 1.0;
            } else {
                document.getElementById('dash-progress-text').textContent = `å¾…å¤ä¹ : ${due} ä¸ªå•è¯`;
                btn.innerHTML = '<span class="material-symbols-rounded">play_arrow</span> å¼€å§‹å­¦ä¹ ';
                btn.disabled = false;
                btn.style.opacity = 1.0;
            }
        }

        // --- å­¦ä¹ æµç¨‹ ---
        function updateReviewQueue() {
            const now = Date.now();
            reviewQueue = wordList.filter(w => !w.mastered && (w.nextReview === 0 || w.nextReview <= now))
                                  .sort((a, b) => a.nextReview - b.nextReview); 
        }

        function loadNextWord() {
            if (currentWordIndex >= reviewQueue.length) {
                showToast("æœ¬è½®å­¦ä¹ ç»“æŸï¼");
                showDashboard();
                return;
            }
            
            currentWord = reviewQueue[currentWordIndex];
            document.getElementById('study-progress').textContent = `${currentWordIndex + 1} / ${reviewQueue.length}`;
            
            const p1 = document.getElementById('phase-1');
            p1.classList.remove('hidden');
            p1.classList.remove('animate-enter');
            void p1.offsetWidth; 
            p1.classList.add('animate-enter');

            document.getElementById('phase-2').classList.add('hidden');
            document.getElementById('phase-3').classList.add('hidden');
            
            document.getElementById('p1-word').textContent = currentWord.word;
            
            speak(currentWord.word); 
        }

        function goToPhase2() {
            const p1 = document.getElementById('phase-1');
            p1.classList.add('hidden');
            
            const p2 = document.getElementById('phase-2');
            p2.classList.remove('hidden');
            
            const isSpelling = document.getElementById('spelling-mode-toggle').checked;
            
            if (isSpelling) {
                document.getElementById('quiz-word-prompt').textContent = currentWord.meaning;
                document.getElementById('quiz-options-container').classList.add('hidden');
                document.getElementById('spelling-container').classList.remove('hidden');
                const input = document.getElementById('spelling-input');
                input.value = '';
                input.className = 'spelling-input'; 
                input.focus();
            } else {
                document.getElementById('quiz-word-prompt').textContent = currentWord.word;
                document.getElementById('spelling-container').classList.add('hidden');
                document.getElementById('quiz-options-container').classList.remove('hidden');
                generateQuizOptions();
            }
        }

        function generateQuizOptions() {
            const container = document.getElementById('quiz-options-container');
            container.innerHTML = '';
            
            let options = [currentWord];
            const others = wordList.filter(w => w.word !== currentWord.word);
            
            while (options.length < 4 && others.length > 0) {
                const randIndex = Math.floor(Math.random() * others.length);
                options.push(others[randIndex]);
                others.splice(randIndex, 1);
            }
            options.sort(() => Math.random() - 0.5);

            options.forEach(opt => {
                const btn = document.createElement('div'); 
                btn.className = 'quiz-option';
                btn.innerText = opt.meaning; 
                btn.onclick = () => checkAnswer(opt.word === currentWord.word, btn);
                container.appendChild(btn);
            });
        }

        function showSpellingHint() {
            const input = document.getElementById('spelling-input');
            const len = currentWord.word.length;
            if (len > 2) {
                 input.value = currentWord.word[0] + '...' + currentWord.word[len-1];
            } else {
                 input.value = currentWord.word[0] + '...';
            }
            input.focus();
        }

        function checkSpelling() {
            const input = document.getElementById('spelling-input');
            const userVal = input.value.trim().toLowerCase().replace(/[.,!?;]$/, "");
            const correctAnswer = currentWord.word.toLowerCase().replace(/[.,!?;]$/, "").trim();
            
            if (userVal === correctAnswer) {
                input.classList.remove('wrong');
                input.classList.add('correct');
                input.classList.add('animate-pop'); 
                
                speak(currentWord.word); 
                setTimeout(() => handleResult(true), 800);
            } else {
                input.classList.add('wrong');
                input.classList.add('animate-shake'); 
                showToast(`æ‹¼å†™é”™è¯¯ï¼Œæ­£ç¡®åº”ä¸º: ${currentWord.word}`);
                setTimeout(() => {
                    input.classList.remove('animate-shake');
                }, 400);
            }
        }

        function checkAnswer(isCorrect, btnElement) {
            if (isCorrect) {
                btnElement.classList.add('correct');
                btnElement.style.transform = "scale(1.02)";
                setTimeout(() => handleResult(true), 600);
            } else {
                btnElement.classList.add('wrong');
                btnElement.classList.add('animate-shake');
                const options = document.querySelectorAll('.quiz-option');
                options.forEach(opt => {
                    if (opt.innerText === currentWord.meaning) {
                        opt.classList.add('correct');
                    }
                });
                setTimeout(() => handleResult(false), 1500);
            }
        }

        function handleResult(success) {
            if (success) {
                currentWord.interval = currentWord.interval === 0 ? 1 : currentWord.interval * 2;
                currentWord.nextReview = Date.now() + (currentWord.interval * 24 * 60 * 60 * 1000);
            } else {
                currentWord.interval = 0; 
                currentWord.nextReview = Date.now(); 
            }
            saveData();
            showPhase3(success);
        }

        function showPhase3(fromSuccess) {
            document.getElementById('phase-2').classList.add('hidden');
            
            const p3 = document.getElementById('phase-3');
            p3.classList.remove('hidden');
            p3.classList.remove('animate-enter');
            void p3.offsetWidth;
            p3.classList.add('animate-enter');
            
            document.getElementById('p3-word').textContent = currentWord.word;
            document.getElementById('p3-meaning').textContent = currentWord.meaning;
            document.getElementById('p3-example-en').textContent = currentWord.example_en || 'æš‚æ— ä¾‹å¥';
            document.getElementById('p3-example-zh').textContent = currentWord.example_zh || '';
            
            if (fromSuccess) {
                 speak(currentWord.word);
            }
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function speak(text) {
            if (!synth) return;
            synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = ttsRate;
            if (voices.length > 0) {
                const googleVoice = voices.find(v => v.name.includes('Google') && v.lang.includes('en-US'));
                if (googleVoice) u.voice = googleVoice;
            }
            u.onerror = (e) => console.error("TTS Error:", e);
            synth.speak(u);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- å¿«æ·é”®è®¾ç½® UI æ¸²æŸ“ ---
        function renderShortcutSettings() {
            const list = document.getElementById('shortcut-list');
            list.innerHTML = '';

            for (const [key, label] of Object.entries(Shortcuts.labels)) {
                const item = document.createElement('div');
                item.className = 'shortcut-item';
                
                const labelDiv = document.createElement('div');
                labelDiv.innerHTML = `<div class="shortcut-label">${label}</div>`;
                
                const addBtn = document.createElement('button');
                addBtn.className = 'add-key-btn';
                addBtn.innerText = '+ æ·»åŠ ';
                addBtn.onclick = (e) => startRecordingKey(e, key);
                labelDiv.appendChild(addBtn);

                const keysDiv = document.createElement('div');
                keysDiv.className = 'shortcut-keys';
                
                Shortcuts.data[key].forEach(code => {
                    const tag = document.createElement('div');
                    tag.className = 'key-tag';
                    // æ ¼å¼åŒ–æ˜¾ç¤ºï¼šSpace -> âµ Space, KeyQ -> Q
                    let display = code.replace('Key', '').replace('Digit', '');
                    if(code === 'Space') display = 'Space';
                    if(code === 'Enter') display = 'Enter';
                    
                    tag.innerHTML = `${display} <span class="material-symbols-rounded">close</span>`;
                    tag.onclick = () => {
                        Shortcuts.remove(key, code);
                        renderShortcutSettings();
                    };
                    keysDiv.appendChild(tag);
                });

                item.appendChild(labelDiv);
                item.appendChild(keysDiv);
                list.appendChild(item);
            }
        }

        let isRecording = false;
        let recordingAction = null;
        let recordingBtn = null;

        function startRecordingKey(e, action) {
            if (isRecording) return;
            isRecording = true;
            recordingAction = action;
            recordingBtn = e.target;
            
            const originalText = recordingBtn.innerText;
            recordingBtn.innerText = 'è¯·æŒ‰é”®...';
            recordingBtn.classList.add('recording');
            
            // ä¸´æ—¶çš„ä¸€æ¬¡æ€§ç›‘å¬å™¨
            const handler = (event) => {
                event.preventDefault();
                event.stopPropagation();
                
                const code = event.code;
                Shortcuts.add(recordingAction, code);
                
                cleanup();
                renderShortcutSettings();
            };
            
            const cleanup = () => {
                isRecording = false;
                recordingBtn.innerText = originalText;
                recordingBtn.classList.remove('recording');
                document.removeEventListener('keydown', handler, true);
                document.onclick = null;
            };

            document.addEventListener('keydown', handler, true);
            
            // ç‚¹å‡»å¤–éƒ¨å–æ¶ˆ
            setTimeout(() => {
                document.onclick = (ev) => {
                    if(ev.target !== recordingBtn) cleanup();
                };
            }, 100);
        }

        // --- æ ¸å¿ƒå¿«æ·é”®å¤„ç† ---
        function handleGlobalKeydown(e) {
            // å¦‚æœæ­£åœ¨å½•åˆ¶ï¼Œæˆ–è€…ç„¦ç‚¹åœ¨è¾“å…¥æ¡†ä¸­ï¼ˆä¸”ä¸æ˜¯Enterï¼‰ï¼Œåˆ™å¿½ç•¥å…¨å±€å¿«æ·é”®
            if (isRecording) return;
            const tag = e.target.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA') {
                // åœ¨è¾“å…¥æ¡†ä¸­åªå…è®¸ Enter è§¦å‘æäº¤ï¼Œå…¶ä»–å¿«æ·é”®å±è”½ï¼Œé˜²æ­¢æ‰“å­—å†²çª
                if (e.code === 'Enter' && e.target.id === 'spelling-input') return; // è®©åŸç”Ÿäº‹ä»¶å¤„ç†
                if (e.code === 'Enter' && e.target.tagName === 'TEXTAREA') return;
                // å¦‚æœæ˜¯ç‰¹æ®ŠåŠŸèƒ½é”®ï¼ˆå¦‚ Hint ç»‘å®šçš„é”®ï¼‰ï¼Œä¸”ç”¨æˆ·æƒ³ç”¨ï¼Œè¿™é‡Œéœ€è¦æƒè¡¡ã€‚
                // ç®€å•èµ·è§ï¼šè¾“å…¥æ—¶å±è”½æ‰€æœ‰è‡ªå®šä¹‰å¿«æ·é”®ï¼Œé™¤äº†ç‰¹å®šçš„ï¼ˆæ¯”å¦‚æƒ³æ”¯æŒå¿«æ·é”®æç¤ºï¼‰
                // ç›®å‰é€»è¾‘ï¼šæ‰“å­—æ—¶å®Œå…¨ä¸è§¦å‘è‡ªå®šä¹‰å¿«æ·é”®
                return;
            }

            const action = Shortcuts.getAction(e.code);
            if (!action) return;

            e.preventDefault(); // é˜»æ­¢é»˜è®¤æ»šåŠ¨ç­‰è¡Œä¸º

            // è·å–å½“å‰ç•Œé¢çŠ¶æ€
            const studyView = document.getElementById('study-view');
            if (studyView.classList.contains('hidden')) return; // ä¸åœ¨å­¦ä¹ ç•Œé¢ä¸è§¦å‘

            const p1 = document.getElementById('phase-1');
            const p2 = document.getElementById('phase-2');
            const p3 = document.getElementById('phase-3');

            // --- é€»è¾‘åˆ†å‘ ---
            if (!p1.classList.contains('hidden')) {
                // é˜¶æ®µ 1ï¼šçœ‹è¯
                if (action === 'confirm') goToPhase2();
                if (action === 'reject') handleResult(false);
                if (action === 'audio') speak(currentWord.word);
                if (action === 'master') document.getElementById('p1-kill-btn').click();
            
            } else if (!p2.classList.contains('hidden')) {
                // é˜¶æ®µ 2ï¼šæµ‹è¯•/æ‹¼å†™
                if (action === 'hint') {
                    // ä»…åœ¨æ‹¼å†™æ¨¡å¼æœ‰æ•ˆ
                    if (!document.getElementById('spelling-container').classList.contains('hidden')) {
                         document.getElementById('hint-spelling-btn').click();
                    }
                }
                // æ³¨æ„ï¼šé€‰é¡¹é€‰æ‹©é€šå¸¸å¤ªå¤æ‚ï¼Œä¸å»ºè®®ç»‘å®šå…¨å±€å¿«æ·é”®ï¼Œé™¤éå›ºå®š 1/2/3/4
                // è¿™é‡Œåªå¤„ç† Hintã€‚Audio ä¹Ÿå¯ä»¥æ”¯æŒ
                if (action === 'audio') speak(currentWord.word);

            } else if (!p3.classList.contains('hidden')) {
                // é˜¶æ®µ 3ï¼šç»“æœ
                if (action === 'confirm') document.getElementById('p3-next-btn').click(); // Next
                if (action === 'reject') document.getElementById('p3-loop-btn').click(); // Retry
                if (action === 'audio') speak(currentWord.word);
            }
        }

        // --- å¯¼å…¥åŠŸèƒ½ ---
        function processImportText(text) {
            const lines = text.split('\n');
            let count = 0;
            lines.forEach(line => {
                const parts = line.split('|').map(p => p.trim());
                if (parts.length >= 2 && parts[0] && parts[1]) {
                    const existingWord = wordList.find(w => w.word.toLowerCase() === parts[0].toLowerCase());
                    if (!existingWord) {
                        wordList.push({
                            id: Date.now() + Math.random().toString(),
                            word: parts[0],
                            meaning: parts[1],
                            example_en: parts[2] || '',
                            example_zh: parts[3] || '',
                            mastered: false,
                            interval: 0,
                            nextReview: 0
                        });
                        count++;
                    }
                }
            });
            saveData();
            showToast(`æˆåŠŸå¯¼å…¥ ${count} ä¸ªæ–°å•è¯`);
            updateDashboard();
            return count;
        }

        document.getElementById('text-import-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const text = document.getElementById('import-text-area').value.trim();
            if (!text) return;
            processImportText(text);
            document.getElementById('text-import-form').reset();
            document.getElementById('text-import-dialog').close();
        });

        document.getElementById('confirm-file-import-btn').addEventListener('click', () => {
            const file = document.getElementById('file-input').files[0];
            if (!file) { showToast("è¯·é€‰æ‹©æ–‡ä»¶"); return; }
            const reader = new FileReader();
            reader.onload = (e) => processImportText(e.target.result);
            reader.readAsText(file);
            document.getElementById('file-import-dialog').close();
        });

        // --- å•è¯æœ¬æ¸²æŸ“ ---
        window.renderBank = function(filter) {
            const list = document.getElementById('bank-list');
            list.innerHTML = '';
            
            let data = wordList;
            if (filter === 'wrong') data = wordList.filter(w => w.interval === 0 && !w.mastered);
            if (filter === 'mastered') data = wordList.filter(w => w.mastered);
            
            if (data.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:var(--md-sys-color-secondary);margin-top:20px;">ç©ºç©ºå¦‚ä¹Ÿ</p>';
                return;
            }

            data.forEach(w => {
                const item = document.createElement('div');
                item.style.cssText = `
                    padding: 16px; border-bottom: 1px solid var(--md-sys-color-outline-variant);
                    display: flex; justify-content: space-between; align-items: center;
                `;
                item.innerHTML = `
                    <div style="flex-grow:1; margin-right:10px;">
                        <div style="font-weight:bold; font-size:1.1rem;">${w.word}</div>
                        <div style="font-size:0.9rem;opacity:0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">${w.meaning}</div>
                    </div>
                    <button class="icon-btn" onclick="deleteWord('${w.id}')" style="color:var(--md-sys-color-error)">
                        <span class="material-symbols-rounded">delete</span>
                    </button>
                `;
                list.appendChild(item);
            });
        };
        
        window.deleteWord = function(id) {
            if(confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªå•è¯å—ï¼Ÿ")) {
                wordList = wordList.filter(w => w.id !== id);
                saveData();
                const activeFilter = document.querySelector('#bank-view .btn-tonal:focus') ? 'all' : 'all'; 
                renderBank(activeFilter);
            }
        };

        // --- äº‹ä»¶ç»‘å®š ---
        function setupEventListeners() {
            document.getElementById('main-start-btn').onclick = showStudy;
            
            // Phase 1
            document.getElementById('p1-speak-btn').onclick = () => speak(currentWord.word);
            document.getElementById('p1-know-btn').onclick = goToPhase2;
            document.getElementById('p1-forget-btn').onclick = () => handleResult(false);
            document.getElementById('p1-kill-btn').onclick = () => {
                if(confirm("ç¡®å®šæ°¸ä¹…ä¸å†å¤ä¹ æ­¤è¯ï¼Ÿ")) {
                    currentWord.mastered = true;
                    saveData();
                    showToast("å·²è®¾ä¸ºæŒæ¡");
                    currentWordIndex++;
                    loadNextWord();
                }
            };
            
            document.getElementById('spelling-mode-toggle').addEventListener('change', () => {
                if (!document.getElementById('phase-2').classList.contains('hidden')) {
                    goToPhase2();
                }
            });

            // Spelling
            document.getElementById('submit-spelling-btn').onclick = checkSpelling;
            document.getElementById('spelling-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkSpelling();
            });
            document.getElementById('hint-spelling-btn').onclick = showSpellingHint;

            // Phase 3
            document.getElementById('p3-speak-btn').onclick = () => speak(currentWord.word);
            document.getElementById('p3-next-btn').onclick = () => {
                currentWordIndex++;
                loadNextWord();
            };
            document.getElementById('p3-loop-btn').onclick = () => {
                currentWord.interval = 0;
                currentWord.nextReview = Date.now();
                saveData();
                showToast("å·²åŠ å…¥å¤ä¹ é˜Ÿåˆ—");
                currentWordIndex++;
                loadNextWord();
            };

            // Settings & Theme
            document.getElementById('theme-toggle').onclick = () => {
                const body = document.body;
                const newTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            };
            
            document.getElementById('reset-data-btn').onclick = () => {
                if(confirm("âš ï¸ å±é™©ï¼šç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å•è¯æ•°æ®å—ï¼Ÿ")) {
                    localStorage.removeItem(STORAGE_KEY);
                    location.reload();
                }
            };
            
            document.getElementById('tts-rate').onchange = (e) => {
                ttsRate = parseFloat(e.target.value);
            };
            
            // å…¨å±€å¿«æ·é”®ç»‘å®š
            document.addEventListener('keydown', handleGlobalKeydown);
        }
    </script>
</body>
</html>
